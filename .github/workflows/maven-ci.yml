name: Java CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ”§ Build Backend with Maven
        run: mvn -B clean package -DskipTests

      - name: ðŸš€ Deploy Backend to Google Cloud VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "ðŸš€ Desplegando nueva versiÃ³n del backend..."
            if [ ! -d "/opt/athenia" ]; then
              sudo mkdir -p /opt/athenia
            fi
            sudo systemctl stop athenia.service || true
            sudo cp ~/athenia-clean/target/*.jar /opt/athenia/app.jar
            sudo systemctl start athenia.service
            echo "âœ… Backend desplegado correctamente."

      - name: ðŸŽ¨ Build & Deploy Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "ðŸ§± Construyendo frontend..."
            cd ~/athenia-clean/athenia-frontend
            npm install --legacy-peer-deps
            npm run build
            sudo rm -rf /var/www/html/*
            sudo cp -r dist/* /var/www/html/
            sudo systemctl restart nginx
            echo "ðŸŽ¨ Frontend actualizado correctamente."

